name: Convert Draw.io Files

on:
  push:
    paths:
      - '**/*.drawio'

jobs:
  convert:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      # Install prerequisites (we need wget, unzip, and the draw.io binary)
      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y wget unzip
          # Download a Linux version of draw.io-desktop (adjust version as needed)
          wget https://github.com/jgraph/drawio-desktop/releases/download/v20.8.0/draw.io-amd64-20.8.0.deb
          sudo dpkg -i draw.io-amd64-20.8.0.deb

      - name: Create output folders
        run: |
          mkdir -p svg_files html_files

      - name: Convert .drawio files to SVG and wrap to HTML
        run: |
          # Find all .drawio files in the repository.
          for file in $(find . -type f -name "*.drawio"); do
            # Get the base filename without extension and remove any leading "./"
            base=$(basename "$file" .drawio)
            echo "Processing $base.drawio..."

            # Export to SVG (adjust the draw.io binary path if needed)
            draw.io --export --format svg --output "svg_files/${base}.svg" "$file"

            # Create an HTML wrapper file
            cat <<EOF > "html_files/${base}.html"
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>${base}</title>
  <style>
    body { margin: 0; padding: 0; }
    svg { max-width: 100%; height: auto; display: block; }
  </style>
</head>
<body>
EOF

            cat "svg_files/${base}.svg" >> "html_files/${base}.html"

            cat <<EOF >> "html_files/${base}.html"
</body>
</html>
EOF

            echo "$(date) - Converted ${base}.drawio to SVG" >> svg_files/CHANGELOG.txt
            echo "$(date) - Wrapped ${base}.svg to HTML" >> html_files/CHANGELOG.txt
          done

      - name: Commit and push changes
        run: |
          git config --local user.name "github-actions[bot]"
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git add svg_files html_files
          # Only commit if there are changes.
          git diff-index --quiet HEAD || git commit -m "Auto-converted draw.io files"
          git push
